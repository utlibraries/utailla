<?php
/**
 * @file
 * Main hooks.
 */

// Objects.
define('UTAILLA_COLLECTION', 'ailla:collection_collection');
define('UTAILLA_ORG_COLLECTION', 'ailla:organization_collection');
define('UTAILLA_ORG_CMODEL', 'ailla:organizationCModel');
define('UTAILLA_RESOURCE_CMODEL', 'ailla:resourceCModel');
define('UTAILLA_CONTRIBUTOR_COLLECTION', 'ailla:persons_collection');
define('UTAILLA_CONTRIBUTOR_CMODEL', 'ailla:personsCModel');
define('UTAILLA_LANGUAGE_CMODEL', 'ailla:languageCModel');
define('UTAILLA_COUNTRY_CMODEL', 'ailla:countryCModel');
// Migrations.
define('UTAILLA_USER_MIGRATION', 'UtaillaUser');
define('UTAILLA_CONTACT_MIGRATION', 'UtaillaContact');
define('UTAILLA_LIMIT_FOR_RESOURCE_IMPORT', 100);
// Relationships.
define('UTAILLA_USER_REL', 'hasAssociatedUser');
define('UTAILLA_CONTACT_REL', 'hasAssociatedContact');
// Autocomplete paths.
define('UTAILLA_LANGUAGE_AUTOCOMPLETE', 'utailla/autocomplete/language');
define('UTAILLA_LANGUAGE_CODE_AUTOCOMPLETE', 'utailla/autocomplete/languageCode');
define('UTAILLA_PARENT_LANGUAGE_AUTOCOMPLETE', 'utailla/autocomplete/parentlanguage');
define('UTAILLA_COUNTRY_AUTOCOMPLETE', 'utailla/autocomplete/countries');
define('UTAILLA_CONTRIBUTOR_AUTOCOMPLETE', 'utailla/autocomplete/contributor');
define('UTAILLA_ORGANIZATION_AUTOCOMPLETE', 'utailla/autocomplete/organization');
define('UTAILLA_ASSOCIATE_CONTRIBUTOR_AUTOCOMPLETE', 'utailla/autocomplete/associate/contributor');

// Second duration of media file authorization.
const UTAILLA_AUTHORIZATION_DURATION = 600;

// Restriction levels.
const UTAILLA_RESTRICTION_LEVEL_1 = 0;
const UTAILLA_RESTRICTION_LEVEL_2 = 1;
const UTAILLA_RESTRICTION_LEVEL_3 = 2;
const UTAILLA_RESTRICTION_LEVEL_4 = 3;

/**
 * Implements hook_menu().
 */
function utailla_menu() {
  $items = array();
  $items[UTAILLA_LANGUAGE_AUTOCOMPLETE] = array(
    'title' => 'Autocomplete language callback',
    'description' => 'Autocomplete to get a language object\'s title.',
    'file' => 'includes/utailla.autocomplete.inc',
    'page callback' => 'utailla_title_by_model_autocomplete',
    'page arguments' => array(3, UTAILLA_LANGUAGE_CMODEL, FALSE),
    'access arguments' => array(ISLANDORA_METADATA_EDIT),
    'type' => MENU_CALLBACK,
  );
  $items[UTAILLA_LANGUAGE_CODE_AUTOCOMPLETE] = array(
    'title' => 'Autocomplete language code callback',
    'description' => 'Autocomplete to get a language object\'s code.',
    'file' => 'includes/utailla.autocomplete.inc',
    'page callback' => 'utailla_language_code_autocomplete',
    'page arguments' => array(3),
    'access arguments' => array(ISLANDORA_METADATA_EDIT),
    'type' => MENU_CALLBACK,
  );
  $items[UTAILLA_PARENT_LANGUAGE_AUTOCOMPLETE] = array(
    'title' => 'Autocomplete parent language callback',
    'description' => 'Autocomplete to get a language object\'s title, filtering by parent language.',
    'file' => 'includes/utailla.autocomplete.inc',
    'page callback' => 'utailla_title_by_model_autocomplete',
    'page arguments' => array(3, UTAILLA_LANGUAGE_CMODEL, TRUE),
    'access arguments' => array(ISLANDORA_METADATA_EDIT),
    'type' => MENU_CALLBACK,
  );
  $items[UTAILLA_COUNTRY_AUTOCOMPLETE] = array(
    'title' => 'Autocomplete country callback',
    'description' => 'Autocomplete to get a country object\'s title.',
    'file' => 'includes/utailla.autocomplete.inc',
    'page callback' => 'utailla_title_by_model_autocomplete',
    'page arguments' => array(3, UTAILLA_COUNTRY_CMODEL, FALSE),
    'access arguments' => array(ISLANDORA_METADATA_EDIT),
    'type' => MENU_CALLBACK,
  );
  $items[UTAILLA_CONTRIBUTOR_AUTOCOMPLETE] = array(
    'title' => 'Autocomplete collector/depositor callback',
    'description' => 'Autocomplete to get a contributor object\'s title.',
    'file' => 'includes/utailla.autocomplete.inc',
    'page callback' => 'utailla_title_by_model_autocomplete',
    'page arguments' => array(3, UTAILLA_CONTRIBUTOR_CMODEL, FALSE),
    'access arguments' => array(ISLANDORA_METADATA_EDIT),
    'type' => MENU_CALLBACK,
  );
  $items[UTAILLA_ASSOCIATE_CONTRIBUTOR_AUTOCOMPLETE] = array(
    'title' => 'Associate contributors callback',
    'description' => 'Autocomplete to get a contributor.',
    'file' => 'includes/utailla.autocomplete.inc',
    'page callback' => 'utailla_associate_contributor_autocomplete',
    'page arguments' => array(4),
    'access arguments' => array(ISLANDORA_METADATA_EDIT),
    'type' => MENU_CALLBACK,
  );
  $items['islandora/object/%islandora_object/manage/utailla_access_levels'] = array(
    'title' => 'Access Levels',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('utailla_access_level_form', 2),
    'access callback' => 'utailla_access_level_access',
    'access arguments' => array('administer utailla access levels', 2),
    'file' => 'includes/access_levels.form.inc',
    'type' => MENU_LOCAL_TASK,
  );
  $items['islandora/object/%islandora_object/manage/overview/add_resource'] = array(
    'title' => 'Add an object to this Resource',
    'page callback' => 'utailla_resource_ingest_action',
    'page arguments' => array(2),
    'type' => MENU_LOCAL_ACTION,
    'file' => 'includes/ingest.form.inc',
    'access callback' => 'utailla_resource_ingest_access',
    'access arguments' => array(2),
  );
  // XXX: Rendering this as a callback so that it isn't editable as a normal
  // view, as the Solr view definition contains a field that breaks the view
  // configuration screen.
  $items['ailla_depositors'] = array(
    'title' => 'AILLA Depositors',
    'page callback' => 'utailla_view_ailla_depositors',
    'type' => MENU_LOCAL_ACTION,
    'access arguments' => array(ISLANDORA_VIEW_OBJECTS),
  );
  return $items;
}

/**
 * Implements hook_islandora_required_objects().
 */
function utailla_islandora_required_objects(IslandoraTuque $connection) {
  module_load_include('inc', 'utailla', 'includes/utilities');
  $module_path = drupal_get_path('module', 'utailla');

  // Language content model.
  $language_cmodel = $connection->repository->constructObject(UTAILLA_LANGUAGE_CMODEL);
  $language_cmodel->owner = 'fedoraAdmin';
  $language_cmodel->label = 'Ailla Language Content Model';
  $language_cmodel->models = 'fedora-system:ContentModel-3.0';
  utailla_set_ds_composite($language_cmodel, 'language_composite_model.xml');

  // Language collection.
  $language_collection = $connection->repository->constructObject('ailla:language_collection');
  $language_collection->owner = 'fedoraAdmin';
  $language_collection->label = 'Language Collection';
  $language_collection->models = 'islandora:collectionCModel';
  $language_collection->relationships->add(FEDORA_RELS_EXT_URI, 'isMemberOfCollection', 'islandora:root');
  utailla_set_collection_policy($language_collection, 'language_collection_policy.xml');
  utailla_set_default_thumb($language_collection);

  // Country content model.
  $country_cmodel = $connection->repository->constructObject(UTAILLA_COUNTRY_CMODEL);
  $country_cmodel->owner = 'fedoraAdmin';
  $country_cmodel->label = 'Ailla Country Content Model';
  $country_cmodel->models = 'fedora-system:ContentModel-3.0';
  utailla_set_ds_composite($country_cmodel, 'country_composite_model.xml');

  // Country collection.
  $country_collection = $connection->repository->constructObject('ailla:country_collection');
  $country_collection->owner = 'fedoraAdmin';
  $country_collection->label = 'Country Collection';
  $country_collection->models = 'islandora:collectionCModel';
  $country_collection->relationships->add(FEDORA_RELS_EXT_URI, 'isMemberOfCollection', 'islandora:root');
  utailla_set_collection_policy($country_collection, 'country_collection_policy.xml');
  utailla_set_default_thumb($country_collection);

  // Collection collection.
  $collection_collection = $connection->repository->constructObject(UTAILLA_COLLECTION);
  $collection_collection->owner = 'fedoraAdmin';
  $collection_collection->label = 'Collections';
  $collection_collection->models = 'islandora:collectionCModel';
  $collection_collection->relationships->add(FEDORA_RELS_EXT_URI, 'isMemberOfCollection', 'islandora:root');
  utailla_set_collection_policy($collection_collection, 'collection_collection_policy.xml');

  // Organization collection.
  $org_collection = $connection->repository->constructObject(UTAILLA_ORG_COLLECTION);
  $org_collection->owner = 'fedoraAdmin';
  $org_collection->label = 'Organizations';
  $org_collection->models = 'islandora:collectionCModel';
  $org_collection->relationships->add(FEDORA_RELS_EXT_URI, 'isMemberOfCollection', 'islandora:root');
  utailla_set_default_thumb($org_collection);
  utailla_set_collection_policy($org_collection, 'organization_collection_policy.xml');

  // Organization content model.
  $org_cmodel = $connection->repository->constructObject(UTAILLA_ORG_CMODEL);
  $org_cmodel->owner = 'fedoraAdmin';
  $org_cmodel->label = 'Organization Content Model';
  $org_cmodel->models = 'fedora-system:ContentModel-3.0';
  utailla_set_ds_composite($org_cmodel, 'organization_composite_model.xml');

  // Resource content model.
  $resource_cmodel = $connection->repository->constructObject(UTAILLA_RESOURCE_CMODEL);
  $resource_cmodel->owner = 'fedoraAdmin';
  $resource_cmodel->label = 'Resource Content Model';
  $resource_cmodel->models = 'fedora-system:ContentModel-3.0';
  utailla_set_ds_composite($resource_cmodel, 'resource_composite_model.xml');

  // Contributor collection.
  $contributor_collection = $connection->repository->constructObject(UTAILLA_CONTRIBUTOR_COLLECTION);
  $contributor_collection->owner = 'fedoraAdmin';
  $contributor_collection->label = 'Persons';
  $contributor_collection->models = 'islandora:collectionCModel';
  $contributor_collection->relationships->add(FEDORA_RELS_EXT_URI, 'isMemberOfCollection', 'islandora:root');
  utailla_set_default_thumb($contributor_collection);
  utailla_set_collection_policy($contributor_collection, 'contributor_collection_policy.xml');

  // Contributor content model.
  $contributor_cmodel = $connection->repository->constructObject(UTAILLA_CONTRIBUTOR_CMODEL);
  $contributor_cmodel->owner = 'fedoraAdmin';
  $contributor_cmodel->label = 'Persons Content Model';
  $contributor_cmodel->models = 'fedora-system:ContentModel-3.0';
  utailla_set_ds_composite($contributor_cmodel, 'contributor_composite_model.xml');

  return array(
    'utailla' => array(
      'title' => t('AILLA'),
      'objects' => array(
        $language_cmodel,
        $language_collection,
        $country_cmodel,
        $country_collection,
        $org_collection,
        $org_cmodel,
        $contributor_collection,
        $contributor_cmodel,
        $collection_collection,
        $resource_cmodel,
      ),
    ),
  );
}

/**
 * Implements hook_islandora_xml_form_builder_forms().
 */
function utailla_islandora_xml_form_builder_forms() {
  $module_path = drupal_get_path('module', 'utailla');
  return array(
    'AILLA Country Form' => array(
      'form_file' => "$module_path/xml/country_mads_form.xml",
    ),
    'AILLA Language Form' => array(
      'form_file' => "$module_path/xml/language_form.xml",
    ),
    'AILLA Collection Form' => array(
      'form_file' => "$module_path/xml/collection_form.xml",
    ),
    'AILLA Resource Form' => array(
      'form_file' => "$module_path/xml/resource_form.xml",
    ),
    'AILLA Contributor Form' => array(
      'form_file' => "$module_path/xml/contributor_form.xml",
    ),
    'AILLA Organization Form' => array(
      'form_file' => "$module_path/xml/organization_form.xml",
    ),
    'AILLA Audio Form' => array(
      'form_file' => "$module_path/xml/audio_form.xml",
    ),
    'AILLA Text Form' => array(
      'form_file' => "$module_path/xml/text_form.xml",
    ),
    'AILLA Video Form' => array(
      'form_file' => "$module_path/xml/video_form.xml",
    ),
    'AILLA Image Form' => array(
      'form_file' => "$module_path/xml/image_form.xml",
    ),
  );
}

/**
 * Implements hook_islandora_xml_form_builder_form_associations().
 */
function utailla_islandora_xml_form_builder_form_associations() {
  return array(
    'ailla_country_mads_form' => array(
      'content_model' => UTAILLA_COUNTRY_CMODEL,
      'form_name' => 'AILLA Country Form',
      'dsid' => 'MADS',
      'title_field' => array('authority', 'english_name'),
      'transform' => FALSE,
      'template' => FALSE,
    ),
    'ailla_language_form' => array(
      'content_model' => UTAILLA_LANGUAGE_CMODEL,
      'form_name' => 'AILLA Language Form',
      'dsid' => 'LANGUAGE',
      'title_field' => array('name_english'),
      'transform' => FALSE,
      'template' => FALSE,
    ),
    'ailla_collection_form' => array(
      'content_model' => 'islandora:collectionCModel',
      'form_name' => 'AILLA Collection Form',
      'dsid' => 'MODS',
      'title_field' => array('titleInfoEnglish', 'title'),
      'transform' => 'mods_to_dc.xsl',
      'template' => FALSE,
    ),
    'ailla_resource_form' => array(
      'content_model' => UTAILLA_RESOURCE_CMODEL,
      'form_name' => 'AILLA Resource Form',
      'dsid' => 'MODS',
      'title_field' => array('titleInfoEnglish', 'title'),
      'transform' => 'mods_to_dc.xsl',
      'self_transform' => 'utailla_resource_form_transform',
      'template' => FALSE,
    ),
    'ailla_contributor_form' => array(
      'content_model' => UTAILLA_CONTRIBUTOR_CMODEL,
      'form_name' => 'AILLA Contributor Form',
      'dsid' => 'MADS',
      'title_field' => FALSE,
      'transform' => FALSE,
      'template' => FALSE,
    ),
    'ailla_organization_form' => array(
      'content_model' => UTAILLA_ORG_CMODEL,
      'form_name' => 'AILLA Organization Form',
      'dsid' => 'MADS',
      'title_field' => array('authority', 'name', 'namePart'),
      'transform' => FALSE,
      'template' => FALSE,
    ),
    'ailla_audio_form' => array(
      'content_model' => 'islandora:sp-audioCModel',
      'form_name' => 'AILLA Audio Form',
      'dsid' => 'MODS',
      'title_field' => FALSE,
      'transform' => 'mods_to_dc.xsl',
      'template' => FALSE,
    ),
    'ailla_video_form' => array(
      'content_model' => 'islandora:sp_videoCModel',
      'form_name' => 'AILLA Video Form',
      'dsid' => 'MODS',
      'title_field' => FALSE,
      'transform' => 'mods_to_dc.xsl',
      'template' => FALSE,
    ),
    'ailla_document_form' => array(
      'content_model' => 'islandora:sp_document',
      'form_name' => 'AILLA Text Form',
      'dsid' => 'MODS',
      'title_field' => FALSE,
      'transform' => 'mods_to_dc.xsl',
      'template' => FALSE,
    ),
    'ailla_pdf_form' => array(
      'content_model' => 'islandora:sp_pdf',
      'form_name' => 'AILLA Text Form',
      'dsid' => 'MODS',
      'title_field' => FALSE,
      'transform' => 'mods_to_dc.xsl',
      'template' => FALSE,
    ),
    'ailla_binary_form' => array(
      'content_model' => 'islandora:binaryObjectCModel',
      'form_name' => 'AILLA Text Form',
      'dsid' => 'MODS',
      'title_field' => FALSE,
      'transform' => 'mods_to_dc.xsl',
      'template' => FALSE,
    ),
    'ailla_basic_image_form' => array(
      'content_model' => 'islandora:sp_basic_image',
      'form_name' => 'AILLA Image Form',
      'dsid' => 'MODS',
      'title_field' => FALSE,
      'transform' => 'mods_to_dc.xsl',
      'template' => FALSE,
    ),
    'ailla_large_image_form' => array(
      'content_model' => 'islandora:sp_large_image_cmodel',
      'form_name' => 'AILLA Image Form',
      'dsid' => 'MODS',
      'title_field' => FALSE,
      'transform' => 'mods_to_dc.xsl',
      'template' => FALSE,
    ),
  );
}

/**
 * Implements hook_permission().
 */
function utailla_permission() {
  $permission = array();

  $permission['administer utailla access levels'] = array(
    'title' => t('Administer Access Levels'),
    'description' => t('Permit access to the "Access Levels" form on collections, resources and files.'),
  );
  $permission['view Person MADS datastream'] = array(
    'title' => t('View the Person MADS datastream'),
    'description' => t('Permit access to view MADS datastreams for Person objects.'),
  );
  $permission['bypass access level restrictions'] = array(
    'title' => t('Bypass Access Level restrictions'),
    'description' => t('Permit access to view datastreams that are restricted by access levels.'),
  );

  return $permission;
}

/**
 * Implements hook_islandora_derivative().
 */
function utailla_islandora_derivative(AbstractObject $object) {
  $mod_path = drupal_get_path('module', 'utailla');
  module_load_include('inc', 'utailla', 'includes/utilities');

  $derivatives = array();

  $derivatives['utailla_restrict'] = array(
    'source_dsid' => NULL,
    'destination_dsid' => NULL,
    'weight' => -100,
    'function' => array(
      'utailla_derivative_set_restriction',
    ),
    'file' => "$mod_path/includes/derivatives.inc",
  );

  if (array_intersect($object->models, utailla_get_media_models())) {
    $derivatives['utailla_label'] = array(
      'source_dsid' => 'OBJ',
      'destination_dsid' => NULL,
      'function' => array(
        'utailla_derivative_set_label_from_obj',
      ),
      'file' => "$mod_path/includes/derivatives.inc",
    );
  }

  return $derivatives;
}

/**
 * Implements hook_islandora_object_alter().
 *
 * Brings restriction up to Level 1, if a PID has already been assigned.
 */
function utailla_islandora_object_alter(AbstractObject $object, &$context) {
  if ($context['action'] == 'ingest') {
    module_load_include('inc', 'utailla', 'includes/utilities');
    utailla_add_restriction_if_missing($object);
  }
}

/**
 * Implements hook_block_info().
 */
function utailla_block_info() {
  return array(
    'utailla_object_credentials' => array(
      'visibility' => BLOCK_VISIBILITY_LISTED,
      'pages' => 'islandora/object/*',
      'cache' => DRUPAL_NO_CACHE,
      'info' => t('Object Credential Input'),
    ),
  );
}

/**
 * Implements hook_block_view().
 */
function utailla_block_view($delta = '') {
  $to_render = array();

  switch ($delta) {
    case 'utailla_object_credentials':
      module_load_include('inc', 'utailla', 'includes/object_credentials');
      module_load_include('inc', 'utailla', 'includes/db');
      module_load_include('inc', 'utailla', 'includes/utilities');
      $object = menu_get_object('islandora_object', 2);
      $restriction = utailla_get_restriction($object->id);
      if ($object &&
        // Objects with a restricion level of 'Authenticated Access' may
        // still contain a password; this is inherited from the collection and
        // exists as a default if the access level is changed.
        isset($restriction['level']) && $restriction['level'] != UTAILLA_RESTRICTION_LEVEL_1 &&
        isset($restriction['password']) && $restriction['password'] &&
        !utailla_user_media_file_current_authorization($object->id) &&
        !utailla_is_object_archived($object)) {

        $to_render['subject'] = t('Unlock Object');
        $to_render['content'] = drupal_get_form(
          'utailla_object_credentials_form',
          $object
        );
      }
      break;
  }
  return $to_render;
}

/**
 * Implements hook_cron().
 *
 * Cleans out of date restrictions and authorizations.
 */
function utailla_cron() {
  module_load_include('inc', 'utailla', 'includes/db');
  utailla_remove_outdated_media_file_authorizations();
  utailla_update_outdated_media_file_restrictions();
}

/**
 * Implements hook_islandora_datastream_access().
 */
function utailla_islandora_datastream_access($op, $datastream, $user) {
  // Block access to MADS datastream for Person objects.
  if ($datastream->id == 'MADS' && in_array(UTAILLA_CONTRIBUTOR_CMODEL, $datastream->parent->models)) {
    return user_access('view Person MADS datastream');
  }

  module_load_include('inc', 'utailla', 'includes/utilities');
  module_load_include('inc', 'utailla', 'includes/db');

  $lockable_dsids = utailla_lockable_dastastreams();
  $pid = $datastream->parent->id;
  $restriction = utailla_get_restriction($pid);
  if (in_array($datastream->id, $lockable_dsids) &&
    $restriction['level'] &&
    !utailla_user_media_file_current_authorization($pid) &&
    !user_access('bypass access level restrictions')) {

    return FALSE;

  }

  return NULL;
}

/**
 * Language Validation for Ailla Collection MODS Form.
 */
function utailla_validate_language_is_in_collection_language($element, &$form_state) {
  $collection_languages = array();
  foreach ($form_state['values']['languages_uri'] as $language) {
    if (!empty($language['language'])) {
      $collection_languages[] = $language['language'];
    }
  }
  if (isset($element['#value'])) {
    if (($element['#value'] && empty($collection_languages)) || ($element['#value'] && !empty($collection_languages) && !in_array($element['#value'], $collection_languages))) {
      form_error($element, t('@lang is not one of the current collection languages.', array('@lang' => $element['#value'])));
    }
  }
}

/**
 * Used by Ailla forms to set language label from hidden PID field.
 */
function utailla_convert_language_pid_to_title($form, $form_state) {
  global $base_url;
  if (isset($form['language_pid']['#value'])) {
    $pid = str_replace("$base_url/islandora/object/", "", $form['language_pid']['#value']);
    $obj = islandora_object_load($pid);
    if ($obj) {
      $form['language']['#value'] = $obj->label;
    }
  }
  return $form;
}

/**
 * Used by Ailla Collection MODS Form to country label from hidden PID field.
 */
function utailla_convert_country_pid_to_title($form, $form_state) {
  global $base_url;
  if (isset($form['country_pid']['#value'])) {
    $pid = str_replace("$base_url/islandora/object/", "", $form['country_pid']['#value']);
    $obj = islandora_object_load($pid);
    if ($obj) {
      $form['country_name']['#value'] = $obj->label;
    }
  }
  return $form;
}

/**
 * Used by Ailla Collection MODS Form to country label from hidden PID field.
 */
function utailla_convert_collection_pid_to_title($form, $form_state) {
  global $base_url;
  if (isset($form['collection_pid']['#value'])) {
    $pid = str_replace("$base_url/islandora/object/", "", $form['collection_pid']['#value']);
    $obj = islandora_object_load($pid);
    if ($obj) {
      $form['collection_name']['#value'] = $obj->label;
    }
  }
  return $form;
}

/**
 * Used by Ailla MADS form to set organization label from hidden PID field.
 */
function utailla_convert_organization_pid_to_title($form, $form_state) {
  global $base_url;
  if (isset($form['organization_pid']['#value'])) {
    $pid = str_replace("$base_url/islandora/object/", "", $form['organization_pid']['#value']);
    $obj = islandora_object_load($pid);
    if ($obj) {
      $form['organization']['#value'] = $obj->label;
    }
  }
  return $form;
}

/**
 * Value callback for populating the visible select from a hidden one.
 */
function utailla_set_visible_select_value_callback($element, $input, $form_state) {
  if ($input === FALSE) {
    $index = 0;
    $form = $form_state['complete form'];
    if (isset($element['#user_data'][0])) {
      $hidden = $element['#user_data'][0];
      $parents = $element['#parents'];
      array_splice($parents, count($parents) - 1, 1, $hidden);
      $hidden_select = drupal_array_get_nested_value($form, $parents);
      $options = array_keys($hidden_select['#options']);
      $default_value = isset($hidden_select['#default_value']) ? $hidden_select['#default_value'] : reset($hidden_select["#options"]);
      $index = array_search($default_value, $options);
    }
    return isset($element['#default_value']) ? $element['#default_value'] : $index;
  }
}

/**
 * Used by Ailla forms to set label from hidden PID field.
 */
function utailla_collection_build_uri_on_validate($element, &$form_state) {
  global $base_url;
  if (!empty($element['#value']) && strpos($element['#value'], $base_url) === FALSE) {
    module_load_include('inc', 'utailla', 'includes/utilities');
    form_set_value($element, utailla_get_uri_from_pid($element['#value']), $form_state);
  }
}

/**
 * Used by Ailla Media forms to set the date in provenance fields.
 */
function utailla_update_provenance_dates($form, $form_state) {
  $date = new DateTime();
  $date = $date->format($date::W3C);
  $form_id = isset($form_state['values']['form_id']) ? $form_state['values']['form_id'] : $form_state['build_info']['form_id'];
  if ($form_id == 'xml_form_builder_datastream_form') {
    $form['date_modified']['#value'] = $date;
  }
  if ($form_id == 'xml_form_builder_ingest_form' || $form_id == 'islandora_ingest_form') {
    $form['date_archived']['#value'] = $date;
  }
  return $form;
}

/**
 * Used by Ailla Media forms to update the Spanish content_type.
 */
function utailla_update_spanish_content_type_on_validate($element, &$form_state) {
  $mapping = array(
    'annotation' => 'anotación',
    'commentary' => 'comentario',
    'context' => 'contexto',
    'guide' => 'guía',
    'illustration' => 'ilustración',
    'interlinearization' => 'interlinearización',
    'interpretation' => 'interpretación',
    'photo' => 'foto',
    'primary text' => 'texto primario',
    'sample' => 'muestra',
    'transcription' => 'transcripción',
    'transcription & translation' => 'transcripción & traducción',
    'translation' => 'traducción',
  );
  $spanish = is_null($form_state['values']['content_type_eng']) ? NULL : $mapping[$form_state['values']['content_type_eng']];
  form_set_value($element, $spanish, $form_state);
}

/**
 * Used by Ailla Media forms to update the Spanish original_medium.
 */
function utailla_update_spanish_original_medium_on_validate($element, &$form_state) {
  // Only values that differ between Spanish and English are included; any
  // other values are carried over outright.
  $mapping = array(
    'audio:cassette' => 'audio:casete',
    'audio:open-reel' => 'audio:carriete abierto',
    'image:analog' => 'imágen:análogo',
    'image:digital' => 'imágen:digital',
    'other' => 'otro',
    'text:archivable digital' => 'texto:digital archivable',
    'text:Excel' => 'texto:Excel',
    'text:manuscript' => 'texto:manuscrito',
    // 15. text:publicado (sic).
    'text:published' => 'texto:publicado',
    'text:Shoe/Toolbox' => 'texto:Shoe/Toolbox',
    'text:unarchivable digital' => 'texto:digital no-archivable',
    'text:unpublished' => 'texto:no-publicado',
    'text:Word' => 'texto:Word',
    'text:WordPerfect' => 'texto:WordPerfect',
    'unknown' => 'desconocido',
    'video:cassette' => 'video:casete',
  );
  $english = $form_state['values']['physicalDescription']['original_medium_eng'];
  $spanish = array_key_exists($english, $mapping) ? $mapping[$english] : $english;
  form_set_value($element, $spanish, $form_state);
}

/**
 * Used by Ailla forms to populate the identifier with the URI.
 */
function utailla_update_identifier_with_uri_on_validate($element, &$form_state) {
  if (empty($element['#value'])) {
    // Object is contained in the islandora array on ingest, and in the build
    // info on modification.
    $object = reset($form_state['build_info']['args']);
    if (!is_subclass_of($object, 'AbstractObject')) {
      $object = reset($form_state['islandora']['objects']);
    }
    if ($object) {
      module_load_include('inc', 'utailla', 'includes/utilities');
      $uri = utailla_get_uri_from_pid($object->id);
      form_set_value($element, $uri, $form_state);
    }
  }
}

/**
 * Language Code Validation for Ailla Collection MODS Form.
 */
function utailla_validate_language_code($element, &$form_state, $form) {

  // We only validate and use the language code if it's linked element is
  // populated. The linked element must share the same parent. Also we
  // require a value if the linked element has a value.
  if (isset($element['#user_data'][0])) {
    $linked = $element['#user_data'][0];
    $parents = $element['#parents'];
    array_splice($parents, count($parents) - 1, 1, $linked);
    $linked_element = drupal_array_get_nested_value($form, $parents);
    if (empty($linked_element['#value'])) {
      // Ignore user given value, and give no error.
      form_set_value($element, '', $form_state);
      return;
    }
    elseif (empty($element['#value'])) {
      // If the linked element has a value a language code must be given.
      form_error($element, t("Language code is required"));
      return;
    }
  }

  module_load_include('inc', 'utailla', 'includes/utilities');
  $results = utailla_get_language_pids();

  $code = $element['#value'];

  if ($code === '') {
    return;
  }

  foreach ($results as $result) {
    $object = islandora_object_load($result['pid']['value']);
    if (isset($object['LANGUAGE'])) {
      $dom = new DOMDocument();
      $dom->loadXML($object['LANGUAGE']->content);
      $dom_xpath = new DOMXPath($dom);
      $lang_codes = $dom_xpath->query('/aillaLanguage/aillaLangCode/text()');
      foreach ($lang_codes as $lang_code) {
        if (strcmp(trim($lang_code->wholeText), trim($code)) == 0) {
          return TRUE;
        }
      }
    }
  }
  form_error($element, t("Language code @code does not belong to any known language in the repository.", array('@code' => $code)));
}

/**
 * Implements hook_cmodel_pid_dsid_islandora_datastream_alter().
 */
function utailla_ailla_personsCModel_MADS_islandora_datastream_alter(AbstractObject $object, AbstractDatastream $datastream, array $context) {
  if ($context['action'] == 'ingest' || $context['action'] == 'modify') {
    module_load_include('inc', 'utailla', 'includes/utilities');
    // See if the label needs to be updated.
    $mads_xml = $context['action'] == 'ingest' ? $datastream->content : $context['params']['dsString'];
    $dom = new DOMDocument();
    $dom->loadXML($mads_xml);
    $xpath = new DOMXPath($dom);
    $xpath->registerNamespace('mads', 'http://www.loc.gov/mads/v2');
    $label = '';
    // Need to first see if the object is anonymous or not.
    $anonymous = $xpath->evaluate('/mads:mads/mads:note[@type="anonymous"]/text() = "Y"');
    if ($anonymous) {
      $nickname = $xpath->evaluate('string(/mads:mads/mads:note[@type="nickname"]/text())');
      if (!empty($nickname)) {
        $label = $nickname;
      }
      else {
        $label = 'Anonymous';
      }
    }
    else {
      $first_name = $xpath->evaluate('string(/mads:mads/mads:authority/mads:name[@type="personal"]/mads:namePart[@type="given"]/text())');
      $last_name = $xpath->evaluate('string(/mads:mads/mads:authority/mads:name[@type="personal"]/mads:namePart[@type="family"]/text())');
      if (!empty($first_name) || !empty($last_name)) {
        $label = '';
        if (!empty($first_name) && empty($last_name)) {
          $label = $first_name;
        }
        elseif (empty($first_name) && !empty($last_name)) {
          $label = $last_name;
        }
        elseif (!empty($first_name) && !empty($last_name)) {
          $label = "{$last_name}, {$first_name}";
        }
      }
    }
    if ($object->label != $label) {
      $object->label = $label;
      // Also need to update dc:title if an update, since it can get set from
      // the label.
      if ($context['action'] == 'modify') {
        $dc_xml = $object['DC']->content;
        $dc_dom = new DOMDocument();
        $dc_dom->loadXML($dc_xml);

        $current_titles = $dc_dom->getElementsByTagName('title');
        if ($current_titles->length) {
          $current_titles->item(0)->parentNode->removeChild($current_titles->item(0));
        }
        if (!$current_titles->length || $current_titles->item(0)->nodeValue != $label) {
          $new_title = $dc_dom->createElementNS('http://purl.org/dc/elements/1.1/', 'title');
          $new_title_text = $dc_dom->createTextNode($label);
          $new_title->appendChild($new_title_text);
          $dc_dom->documentElement->appendChild($new_title);
          $object['DC']->setContentFromString($dc_dom->saveXML());
        }
      }
    }
    // Go out and see if the XACML policy needs to be updated or lifted for
    // contributors.
    if (in_array(UTAILLA_CONTRIBUTOR_CMODEL, $object->models)) {
      utailla_update_contributor_anonymous_policy($object, $anonymous);
    }
  }
}

/**
 * Implements hook_islandora_solr_query_alter().
 */
function utailla_islandora_solr_query_alter($qp) {
  $object = menu_get_object('islandora_object', 2);
  // Only want to modify from the default sort in the case of the collection
  // view search results.
  if ($object && current_path() == "islandora/object/{$object->id}" && in_array('islandora:collectionCModel', $object->models)) {
    $qp->solrParams['sort'] = 'fgs_label_ss asc';
  }
}

/**
 * Implements hook_islandora_datastream_alter().
 */
function utailla_islandora_datastream_alter(AbstractObject $object, AbstractDatastream $datastream, &$context) {
  $mads_cmodels = array(
    UTAILLA_COUNTRY_CMODEL,
    UTAILLA_CONTRIBUTOR_CMODEL,
    UTAILLA_ORG_CMODEL,
  );
  // Add PID to the MADS record.
  if ($context['action'] == 'ingest' && $datastream->id == 'MADS' && array_intersect($object->models, $mads_cmodels)) {
    if (isset($object['MADS'])) {
      $mads_dom = new DOMDocument();
      $mads_dom->loadXML($object['MADS']->content);
      $record_info = $mads_dom->createElement('recordInfo');
      $record_identifier = $mads_dom->createElement('recordIdentifier', $object->id);
      $record_info->appendChild($record_identifier);
      $mads_dom->documentElement->appendChild($record_info);
      $object['MADS']->content = $mads_dom->saveXML();
    }
  }
}


/**
 * Implements hook_islandora_ingest_steps_CMODEL_PID().
 */
function utailla_islandora_collectionCModel_islandora_ingest_steps($form_state) {
  module_load_include('inc', 'islandora', 'includes/ingest.form');
  $shared_storage = islandora_ingest_form_get_shared_storage($form_state);
  // As AILLA has custom requirements for applying a specific COLLECTION_POLICY
  // we need to add a step that will add it. This route is being used as opposed
  // to an object_ingested or alter implementation to mitigate any potential
  // fallout that could occur when interacting with the sleep mechanisms
  // currently in place in their migration.
  if ($shared_storage['parent'] == 'ailla:collection_collection') {
    return array(
      'utailla_collection_policy' => array(
        'type' => 'callback',
        'weight' => -11,
        'module' => 'utailla',
        'do_function' => array(
          'function' => 'utailla_apply_collection_policy',
          'args' => array('resource'),
        ),
      ),
    );
  }
}

/**
 * Implements hook_islandora_ingest_steps_CMODEL_PID().
 */
function utailla_ailla_resourceCModel_islandora_ingest_steps($form_state) {
  return array(
    'utailla_collection_policy' => array(
      'type' => 'callback',
      'weight' => -11,
      'module' => 'utailla',
      'do_function' => array(
        'function' => 'utailla_apply_collection_policy',
        'args' => array('media'),
      ),
    ),
  );
}

/**
 * Implements hook_islandora_ingest_steps_CMODEL_PID_alter().
 */
function utailla_islandora_collectionCModel_islandora_ingest_steps_alter(&$steps, &$form_state) {
  $shared_storage = islandora_ingest_form_get_shared_storage($form_state);
  if ($shared_storage['parent'] == 'ailla:collection_collection' && isset($steps['islandora_basic_collection'])) {
    unset($steps['islandora_basic_collection']);
  }
}

/**
 * Callback to add AILLA's COLLECTION_POLICY to the collection object.
 *
 * @param array $form_state
 *   An array containing the Drupal form state.
 * @param string $type
 *   The type of COLLECTION_POLICY to apply either 'resource' or 'media'.
 */
function utailla_apply_collection_policy(&$form_state, $type) {
  module_load_include('inc', 'islandora', 'includes/ingest.form');
  $module_path = drupal_get_path('module', 'utailla');
  $object = islandora_ingest_form_get_object($form_state);
  $ds = $object->constructDatastream('COLLECTION_POLICY', 'M');
  $ds->mimetype = 'application/xml';
  $ds->label = 'Collection policy';
  $ds->setContentFromFile("$module_path/xml/{$type}_collection_policy.xml", FALSE);
  $object->ingestDatastream($ds);
}

/**
 * Callback to remove AILLA's COLLECTION_POLICY from the collection object.
 *
 * @param array $form_state
 *   An array containing the Drupal form state.
 */
function utailla_undo_collection_policy(&$form_state) {
  module_load_include('inc', 'islandora', 'includes/ingest.form');
  $object = islandora_ingest_form_get_object($form_state);
  if (isset($object['COLLECTION_POLICY'])) {
    $object->purgeDatastream('COLLECTION_POLICY');
  }
}

/**
 * Determine whether to display the "Add a resource" action.
 *
 * @param AbstractObject $resource
 *   An AbstractObject representing an object within Fedora.
 *
 * @return bool
 *   TRUE if the user has access, FALSE otherwise.
 *
 * @see islandora_basic_collection_ingest_access()
 */
function utailla_resource_ingest_access(AbstractObject $resource) {
  $is_a_resource = in_array('ailla:resourceCModel', $resource->models) && isset($resource['COLLECTION_POLICY']);

  if (!$is_a_resource) {
    return FALSE;
  }

  module_load_include('inc', 'islandora', 'includes/ingest.form');
  module_load_include('inc', 'utailla', 'includes/ingest.form');
  $configuration = utailla_resource_get_ingest_configuration($resource);
  $has_ingest_steps = islandora_ingest_can_display_ingest_form($configuration);

  return $has_ingest_steps && islandora_object_access(ISLANDORA_INGEST, $resource);
}

/**
 * Implements hook_menu_alter().
 */
function utailla_menu_alter(&$items) {
  $items['islandora/object/%islandora_object/manage/collection']['page callback'] = 'utailla_manage_collection_and_resource_object';
  $items['islandora/object/%islandora_object/manage/collection']['access callback'] = 'utailla_collection_and_resource_manage_access';
  unset($items['islandora/object/%islandora_object/manage/collection']['file']);

  $object_path =& $items['islandora/object/%islandora_object'];
  $object_path['title arguments'][] = $object_path['title callback'];
  $object_path['title callback'] = 'utailla_media_file_title_callback';
}

/**
 * Access check for rendering the collection tab.
 *
 * @param AbstractObject $object
 *   An AbstractObject representing an object within Fedora.
 *
 * @return bool
 *   TRUE if the user has access, FALSE otherwise.
 */
function utailla_collection_and_resource_manage_access(AbstractObject $object) {
  return array_intersect(array('islandora:collectionCModel', 'ailla:resourceCModel'), $object->models) && (islandora_object_access(ISLANDORA_BASIC_COLLECTION_MANAGE_COLLECTION_POLICY, $object) ||
    islandora_object_access(ISLANDORA_BASIC_COLLECTION_MIGRATE_COLLECTION_MEMBERS, $object) ||
    islandora_object_access(ISLANDORA_INGEST, $object) ||
    islandora_object_access(ISLANDORA_PURGE, $object));
}

/**
 * Wrapper for the management page for collections/resource.
 *
 * @param AbstractObject $object
 *   An AbstractObject representing an object within Fedora.
 *
 * @return array
 *   An array containing the collection/resource management to be rendered.
 */
function utailla_manage_collection_and_resource_object(AbstractObject $object) {
  global $user;
  module_load_include('inc', 'islandora_basic_collection', 'includes/manage_collection');
  $data = islandora_basic_collection_manage_object($object);

  // AILLA's resources act like collection so let's do some custom checking
  // and toggle access as needed.
  if (in_array('ailla:resourceCModel', $object->models)) {
    // May same redundant but need to do it this way unfortunately.
    $policy_management_access = islandora_datastream_access(ISLANDORA_METADATA_EDIT, $object['COLLECTION_POLICY'], $user);
    $data['manage_collection_object']['policy_management']['#access'] = $policy_management_access;
    if ($policy_management_access) {
      $data['manage_collection_object']['policy_management']['form'] = drupal_get_form('islandora_basic_collection_policy_management_form', $object);
    }

    $share_migrate_children_access = islandora_datastream_access(ISLANDORA_METADATA_EDIT, $object['RELS-EXT'], $user);
    $data['manage_collection_object']['share_children']['#access'] = $share_migrate_children_access;
    $data['manage_collection_object']['migrate_children']['#access'] = $share_migrate_children_access;
    if ($share_migrate_children_access) {
      $data['manage_collection_object']['share_children']['form'] = drupal_get_form('islandora_basic_collection_share_children_form', $object);
      $data['manage_collection_object']['migrate_children']['form'] = drupal_get_form('islandora_basic_collection_migrate_children_form', $object);
    }
  }
  return $data;
}

/**
 * Custom access callback for 'Access Level' tab.
 */
function utailla_access_level_access($perm, $object = NULL) {
  module_load_include('inc', 'utailla', 'includes/utilities');
  if (utailla_is_object_archived($object)) {
    return FALSE;
  }
  return islandora_object_access($perm, $object);
}

/**
 * Custom Validation for association contributor autocomplete.
 */
function utailla_association_contributor_validate($element, &$form_state, &$form) {
  if (!empty($element['namepart_autocomplete']['#value'])) {
    // Get the PID from the autocomplete - this is based on returned format in
    // utailla.autocomplete.inc and is required to split the name into nameparta
    // and save the valueURI so the relationship with the object can be
    // maintained.
    $pieces = explode('(', trim($element['namepart_autocomplete']['#value'], ')'));
    if (count($pieces) > 1) {
      module_load_include('inc', 'utailla', 'includes/utilities');
      // PID is always the last part of the autocomplete results.
      $pid = end($pieces);
      $object = islandora_object_load($pid);
      if ($object) {
        // The contributor is a person object.
        if (in_array(UTAILLA_CONTRIBUTOR_CMODEL, $object->models)) {
          // Get the namepart data from object MADS and update hidden form
          // fields.
          $name_data = utailla_get_contributor_nameparts_from_mads($object['MADS']->content);
          form_set_value($element['name_type'], "personal", $form_state);
          form_set_value($element['authority'], "aillaPerson", $form_state);
          // Display label should only exist in the resource form and not the
          // collection form.
          if (isset($element['display_label'])) {
            form_set_value($element['display_label'], "Contributor (Individual)", $form_state);
          }
        }
        else {
          // The contributor is an organization.
          form_set_value($element['name_type'], "corporate", $form_state);
          form_set_value($element['authority'], "aillaOrganization", $form_state);
          // Display label should only exist in the resource form and not the
          // collection form.
          if (isset($element['display_label'])) {
            form_set_value($element['display_label'], "Contributor (Organization)", $form_state);
          }
        }
        form_set_value($element['contributor_pid'], utailla_get_uri_from_pid($pid), $form_state);
      }
    }
  }
}

/**
 * Contributor populate autocomplete field using hidden nameparts and PID.
 */
function utailla_convert_hidden_nameparts_to_autocomplete($form, $form_state) {
  global $base_url;
  if (empty($form['namepart_autocomplete']['#value'])) {
    module_load_include('inc', 'islandora_solr', 'includes/utilities');
    if (!empty($form['contributor_pid']['#value'])) {
      $pid = str_replace("$base_url/islandora/object/", "", $form['contributor_pid']['#value']);
      $escaped_pid = islandora_solr_lesser_escape($pid);
      $qp = new IslandoraSolrQueryProcessor();
      $qp->buildQuery("PID:$escaped_pid");
      $qp->solrParams['fl'] = 'PID, fgs_label_s';
      $qp->executeQuery(FALSE);
      $object = reset($qp->islandoraSolrResult['response']['objects']);
      $label = $object ? $object['solr_doc']['fgs_label_s'] : "";
      $form['namepart_autocomplete']['#value'] = $label;
    }
  }
  return $form;
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function utailla_form_islandora_solr_admin_settings_alter(&$form, &$form_state) {
  // Add a custom field to the required_solr_fields section for the label search
  // field to be used when searching contributor objects with the autocomplete.
  $form['islandora_solr_tabs']['required_solr_fields']['utailla_contributor_search_field'] = array(
    '#type' => 'textfield',
    '#title' => t('Contributor object label Solr search field'),
    '#size' => 30,
    '#description' => t("The Solr field containing an object's label. This should be a single valued or multi valued text field."),
    '#default_value' => variable_get('utailla_contributor_search_field', 'fgs_label_t'),
    '#required' => TRUE,
  );
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function utailla_form_islandora_video_upload_form_alter(&$form, &$form_state) {
  // Add mpeg and mpg as video upload options.
  $upload_size = min((int) ini_get('post_max_size'), (int) ini_get('upload_max_filesize'));
  $extensions = array('ogg mp4 mov qt m4v avi mkv mpeg mpg');
  $form['file']['#upload_validators']['file_validate_extensions'] = $extensions;
  $form['file']['#description'] = t('Select video to upload.<br/>Files must be less than <strong>@size MB.</strong><br/>Allowed file types: <strong>@ext.</strong>', array('@size' => $upload_size, '@ext' => $extensions[0]));
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function utailla_form_islandora_audio_audio_upload_form_alter(&$form, &$form_state) {
  // AILLA doesn't want the thumbnail upload option.
  $form['supply_thumbnail']['#access'] = FALSE;
  $form['thumbnail_section']['#access'] = FALSE;
}

/**
 * Title callback; get OBJ title for media if not set to the object.
 *
 * Something of a superficial improvement, to ensure that the media file title
 * is visible immediately after the ingest. Being set on the object (and
 * therefore appearing elsewhere in the GUI) occurs later, in a derivative
 * callback.
 */
function utailla_media_file_title_callback(AbstractObject $object) {
  $titles =& drupal_static(__FUNCTION__, array());

  if (!isset($titles[$object->id])) {
    $args = func_get_args();
    $wrapped = end($args);
    $wrapped_args = array_slice($args, 0, -1);

    module_load_include('inc', 'utailla', 'includes/utilities');
    if (array_intersect($object->models, utailla_get_media_models()) && $object->label == 'New Object' && isset($object['OBJ'])) {
      $title = $object['OBJ']->label;
    }
    else {
      $title = call_user_func_array($wrapped, $wrapped_args);
    }
    $titles[$object->id] = $title;
  }

  return $titles[$object->id];
}

/**
 * Implemenets hook_xml_form_builder_get_self_transforms().
 */
function utailla_xml_form_builder_get_self_transforms() {
  return array(
    'utailla_resource_form_transform' => drupal_get_path('module', 'utailla') . '/transforms/resource_cleanup.xsl',
  );
}

/**
 * Callback to render the AILLA Depositors view.
 */
function utailla_view_ailla_depositors() {
  $view = views_get_view('ailla_depositors');
  // XXX: Using view::preview() might sound weird, but view::render() is only
  // actually for use in theme elements, whereas view::preview() is safe for use
  // in menu callbacks.
  return $view->preview();
}
